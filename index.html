<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, user-scalable=no" />
  <title>XGP ë¯¸ë‹ˆê²Œì„ (SHOP ëª¨ë°”ì¼ ìµœì í™”)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <style>
    :root{
      --txt:#fff6e6;
      --muted:#ffd9a6;
      --line:#ffb347;

      --panel: rgba(20,12,40,.55);
      --accent:#7df9ff;
      --warn:#ffd166;
      --danger:#ff4d4d;

      --uiShadow: 0 12px 40px rgba(0,0,0,.35);

      /* Jet VFX vars (tier-based) */
      --jetAuraA: 0.18;
      --jetAuraB: 0.08;
      --jetAuraHue: 190deg;
      --jetRingA: 0.18;
      --jetRingHue: 190deg;
      --trailA: 0.55;
      --trailHue: 190deg;

      /* Warning colors */
      --warnLine: rgba(255,209,102,.9);
      --warnGlow: rgba(255,209,102,.35);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:"Press Start 2P", system-ui, sans-serif;
      color:var(--txt);
      overflow:hidden;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;

      background:
        radial-gradient( circle at 15% 20%, rgba(255,255,255,.18), transparent 35% ),
        radial-gradient( circle at 85% 35%, rgba(255,120,60,.20), transparent 42% ),
        radial-gradient( circle at 20% 85%, rgba(0,255,255,.08), transparent 45% ),
        linear-gradient( 135deg, #1a1f4a 0%, #1b1f3a 22%, #2d1557 48%, #b31217 100% );
    }

    .posterGrid{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.24;
      mix-blend-mode:screen;
      background:
        linear-gradient(to right, rgba(255,255,255,.09) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.07) 1px, transparent 1px);
      background-size: 64px 64px;
      transform: perspective(900px) rotateX(7deg);
      filter: blur(.2px);
    }
    .grain{
      position:fixed; inset:-40%;
      pointer-events:none;
      opacity:.09;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      animation: grainMove 6s steps(8) infinite;
      mix-blend-mode: overlay;
    }
    @keyframes grainMove{
      0%{ transform: translate(0,0) rotate(0deg); }
      25%{ transform: translate(-2%,1%) rotate(1deg); }
      50%{ transform: translate(2%,-1%) rotate(-1deg); }
      75%{ transform: translate(-1%,-2%) rotate(1deg); }
      100%{ transform: translate(0,0) rotate(0deg); }
    }

    .wrap{ width:100%; max-width:600px; }

    .title{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; margin-bottom:12px;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .title h1{ font-size:14px; margin:0; letter-spacing:1px; }
    .title .mini{ font-size:9px; color:var(--muted); }

    .card{
      background:
        radial-gradient(circle at 20% 10%, rgba(255,255,255,.10), transparent 40%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:2px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--uiShadow);
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(2px);
    }

    .hud{
      display:flex;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .pill{
      flex:1;
      min-width:170px;
      background: var(--panel);
      border:2px solid rgba(255,180,90,.85);
      border-radius:12px;
      padding:10px 10px;
      font-size:10px;
      color:var(--muted);
      box-shadow: inset 0 0 22px rgba(255,160,60,.10);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill b{ color:var(--txt); }

    .game{
      position:relative;
      width:100%;
      aspect-ratio: 3 / 4;
      max-height: 80vh;
      overflow:hidden;
      border:2px solid var(--line);
      border-radius:14px;
      background:
        radial-gradient(circle at 40% 25%, rgba(125,249,255,.10), transparent 45%),
        radial-gradient(circle at 75% 70%, rgba(255,120,60,.12), transparent 40%),
        linear-gradient(180deg, #0b0e22 0%, #070812 100%);
      box-shadow:
        inset 0 0 60px rgba(255,120,40,0.12),
        0 16px 36px rgba(0,0,0,.35);
      touch-action:none;
      contain: layout paint size;
    }

    .spaceLayer{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:1;
      z-index:0;
    }
    .spaceLayer::before,
    .spaceLayer::after{
      content:"";
      position:absolute; inset:-20%;
      background-image:
        radial-gradient(#ffffffcc 1px, transparent 1px),
        radial-gradient(#ffffff88 1px, transparent 1px),
        radial-gradient(#ffffff55 1px, transparent 1px),
        radial-gradient(rgba(125,249,255,.55) 1px, transparent 1px);
      background-size: 110px 110px, 170px 170px, 240px 240px, 320px 320px;
      background-position: 0 0, 40px 70px, 90px 10px, 120px 150px;
      filter: drop-shadow(0 0 6px rgba(125,249,255,.16));
      transform: rotate(6deg);
      animation: starDrift 8.5s linear infinite;
      opacity:.85;
    }
    .spaceLayer::after{
      opacity:.55;
      filter: drop-shadow(0 0 8px rgba(255,170,60,.14));
      animation-duration: 5.8s;
      animation-direction: reverse;
      transform: rotate(-4deg);
    }
    @keyframes starDrift{
      from{ transform: translateY(0) translateX(0) rotate(6deg); }
      to  { transform: translateY(240px) translateX(-40px) rotate(6deg); }
    }

    .streak{
      position:absolute;
      width:220px; height:2px;
      background: linear-gradient(to right, transparent, rgba(255,255,255,.9), transparent);
      filter: drop-shadow(0 0 10px rgba(125,249,255,.35));
      transform: rotate(18deg);
      opacity:0;
      pointer-events:none;
      animation: streak 2.8s linear infinite;
      z-index:0;
    }
    .streak.s2{ animation-delay: .9s; top:35%; left:-40%; }
    .streak.s1{ top:18%; left:-60%; }
    @keyframes streak{
      0%{ transform: translateX(0) rotate(18deg); opacity:0; }
      10%{ opacity:.55; }
      35%{ opacity:.9; }
      60%{ opacity:.55; }
      100%{ transform: translateX(160vw) rotate(18deg); opacity:0; }
    }

    /* ===== PLAYER ===== */
    .player{
      position:absolute;
      width:56px;
      height:56px;
      z-index:6;
      will-change: transform;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
      transform: translate3d(0,0,0) rotate(0deg);
    }

    .player::after{
      content:"";
      position:absolute;
      inset:-14px;
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(125,249,255,var(--jetAuraA)) 0%,
          rgba(125,249,255,var(--jetAuraB)) 38%,
          rgba(0,0,0,0) 70%);
      filter:
        hue-rotate(var(--jetAuraHue))
        drop-shadow(0 0 18px rgba(125,249,255,0.25));
      opacity:.95;
      pointer-events:none;
      mix-blend-mode: screen;
      animation: auraPulse 1.05s ease-in-out infinite;
    }
    @keyframes auraPulse{
      0%,100%{ transform: scale(0.98); opacity:.86; }
      50%{ transform: scale(1.06); opacity:1; }
    }

    .jetSprite{
      width:100%;
      height:100%;
      background-repeat:no-repeat;
      background-position:center;
      background-size:contain;
      image-rendering:auto;
      transition: filter 260ms ease, transform 260ms ease;
      filter: none;
    }

    .player::before{
      content:"";
      position:absolute;
      left:50%;
      bottom:-6px;
      width:8px;
      height:12px;
      transform: translateX(-50%);
      background:
        radial-gradient(circle at 50% 8%, rgba(255,255,255,.55) 0 20%, transparent 21%),
        radial-gradient(circle at 50% 42%, rgba(255,209,102,.92) 0 52%, transparent 53%),
        radial-gradient(circle at 50% 78%, rgba(255,106,61,.92) 0 78%, transparent 79%);
      filter:
        hue-rotate(var(--trailHue))
        drop-shadow(0 0 7px rgba(255,170,60,.45))
        drop-shadow(0 0 14px rgba(125,249,255,var(--trailA)));
      border-radius: 999px;
      opacity:.85;
      animation: flameFlicker .11s infinite alternate;
      pointer-events:none;
    }
    @keyframes flameFlicker{
      from{ transform: translateX(-50%) scaleY(.92) scaleX(.98) translateY(0); opacity:.72; }
      to  { transform: translateX(-50%) scaleY(1.18) scaleX(1.02) translateY(1px); opacity:.96; }
    }

    /* ===== OBJECTS ===== */
    .hazard, .star, .jetParticle, .tierRing, .warnLine, .warnCircle{
      position:absolute;
      pointer-events:none;
      will-change: transform, opacity;
      transform: translate3d(var(--x, 0px), var(--y, 0px), 0);
    }

    .hazard{
      z-index:4;
      border-radius:50%;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.45)) drop-shadow(0 0 14px rgba(140,90,255,.35));
      animation: hazardWiggle .55s ease-in-out infinite;
    }
    @keyframes hazardWiggle{
      0%,100%{ transform: translate3d(var(--x,0px), var(--y,0px), 0) rotate(-2deg) scale(1); }
      50%     { transform: translate3d(var(--x,0px), var(--y,0px), 0) rotate( 2deg) scale(1.03); }
    }
    .hazard.spin{ animation: hazardSpin .45s linear infinite; }
    @keyframes hazardSpin{
      from{ transform: translate3d(var(--x,0px), var(--y,0px), 0) rotate(0deg); }
      to  { transform: translate3d(var(--x,0px), var(--y,0px), 0) rotate(360deg); }
    }

    .star{
      z-index:4;
      width:28px; height:28px;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      filter: drop-shadow(0 0 12px rgba(255,210,90,.45));
      animation: starPulse .75s ease-in-out infinite;
    }
    @keyframes starPulse{
      0%,100%{ transform: translate3d(var(--x,0px), var(--y,0px), 0) scale(1); }
      50%     { transform: translate3d(var(--x,0px), var(--y,0px), 0) scale(1.12); }
    }

    .jetParticle{
      z-index:5;
      width:6px; height:6px;
      border-radius:999px;
      background:
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.9), rgba(255,255,255,.0) 60%),
        radial-gradient(circle at 60% 60%, rgba(125,249,255,.85), rgba(0,0,0,0) 62%);
      filter: hue-rotate(var(--trailHue)) drop-shadow(0 0 10px rgba(125,249,255,.22));
      opacity:.95;
      animation: jp 520ms ease-out forwards;
    }
    @keyframes jp{
      from{ opacity:.95; transform: translate3d(var(--x,0px), var(--y,0px), 0) scale(1); }
      to{ opacity:0; transform: translate3d(calc(var(--x,0px) + var(--dx,0px)), calc(var(--y,0px) + var(--dy,20px)), 0) scale(.2); }
    }

    .tierRing{
      z-index:12;
      width:160px; height:160px;
      transform: translate(-50%,-50%);
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,255,255,.0) 0%,
          rgba(255,255,255,.0) 45%,
          rgba(125,249,255,var(--jetRingA)) 55%,
          rgba(0,0,0,0) 72%);
      filter: hue-rotate(var(--jetRingHue)) drop-shadow(0 0 22px rgba(125,249,255,.28));
      mix-blend-mode: screen;
      opacity:0;
      animation: ring 520ms ease-out forwards;
    }
    @keyframes ring{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.45); }
      20%{ opacity:1; }
      100%{ opacity:0; transform: translate(-50%,-50%) scale(1.55); }
    }

    /* ===== Warning telegraph (laser line + impact circle) ===== */
    .warnLine{
      z-index:2;
      left:0; top:0;
      width:6px;
      height:100%;
      transform: translate3d(var(--x,0px), 0, 0);
      background:
        linear-gradient(to bottom,
          rgba(0,0,0,0),
          var(--warnLine),
          rgba(0,0,0,0));
      opacity:0;
      filter: drop-shadow(0 0 10px var(--warnGlow)) drop-shadow(0 0 18px rgba(255,120,60,.15));
      animation: warnPulse 520ms ease-in-out infinite;
      border-radius:999px;
    }
    @keyframes warnPulse{
      0%,100%{ opacity:0.25; }
      50%{ opacity:0.95; }
    }

    .warnCircle{
      z-index:2;
      width:120px; height:120px;
      transform: translate(-50%,-50%);
      border-radius:999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(255,209,102,.0) 0%,
          rgba(255,209,102,.0) 50%,
          rgba(255,209,102,.45) 58%,
          rgba(255,209,102,0) 72%);
      filter: drop-shadow(0 0 16px var(--warnGlow));
      opacity:0.0;
      animation: circlePulse 520ms ease-in-out infinite;
    }
    @keyframes circlePulse{
      0%,100%{ opacity:0.25; transform: translate(-50%,-50%) scale(.92); }
      50%{ opacity:0.90; transform: translate(-50%,-50%) scale(1.05); }
    }

    .explosion{
      position:absolute;
      width:120px;
      height:120px;
      transform: translate(-50%, -50%);
      pointer-events:none;
      border-radius:999px;
      opacity:0;
      filter: drop-shadow(0 0 18px rgba(255,160,60,.65));
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='160' height='160' viewBox='0 0 160 160'%3E%3Cdefs%3E%3CradialGradient id='a' cx='50%25' cy='50%25' r='60%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff'/%3E%3Cstop offset='28%25' stop-color='%23fff1a8'/%3E%3Cstop offset='55%25' stop-color='%23ffd166'/%3E%3Cstop offset='78%25' stop-color='%23ff6a3d'/%3E%3Cstop offset='100%25' stop-color='%23d11f2f'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cpath d='M80 8l10 22 18-16 2 24 22-10-10 22 24 2-16 18 22 10-22 10 16 18-24 2 10 22-22-10-2 24-18-16-10 22-10-22-18 16-2-24-22 10 10-22-24-2 16-18-22-10 22-10-16-18 24-2-10-22 22 10 2-24 18 16z' fill='url(%23a)'/%3E%3Ccircle cx='80' cy='80' r='28' fill='%23ffffff' fill-opacity='.35'/%3E%3C/svg%3E");
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      animation: boom .42s ease-out forwards;
      z-index:10;
    }
    @keyframes boom{
      0%{ transform: translate(-50%, -50%) scale(.35); opacity:0; }
      15%{ opacity:1; }
      65%{ transform: translate(-50%, -50%) scale(1.85); opacity:1; }
      100%{ transform: translate(-50%, -50%) scale(2.5); opacity:0; }
    }

    .shake{ animation: shake .18s linear 3; }
    @keyframes shake{
      0%{ transform: translate(0,0); }
      25%{ transform: translate(3px, -2px); }
      50%{ transform: translate(-3px, 2px); }
      75%{ transform: translate(2px, 2px); }
      100%{ transform: translate(0,0); }
    }

    .btnRow{ display:flex; gap:10px; margin-top:12px; }
    button{
      flex:1;
      border:2px solid var(--line);
      background: var(--panel);
      color: var(--txt);
      font-family: inherit;
      padding:12px 10px;
      border-radius:12px;
      font-size:10px;
      cursor:pointer;
      box-shadow: inset 0 0 20px rgba(255,170,60,.10);
    }
    button:active{ transform: translateY(1px); }
    .primary{ border-color: var(--accent); }
    .danger{ border-color: var(--danger); color: #ffecec; }

    .help{
      margin-top:10px;
      color:var(--muted);
      font-size:9px;
      line-height:1.55;
      opacity:.95;
    }

    /* ===== Overlay / Start ===== */
    .overlay{
      position:absolute; inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      z-index: 30;
      overflow:hidden;
    }

    .startBg{
      position:absolute; inset:0;
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
      transform: scale(1.02);
      animation: startPan 6.5s ease-in-out infinite alternate;
      filter: saturate(1.1) contrast(1.05);
    }
    @keyframes startPan{
      from{ transform: scale(1.04) translate3d(-8px,-6px,0); }
      to  { transform: scale(1.08) translate3d(10px,8px,0); }
    }

    .scanlines{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.28;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,.06) 0px,
          rgba(255,255,255,.06) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 6px
        );
      mix-blend-mode: overlay;
      animation: scanMove 2.2s linear infinite;
    }
    @keyframes scanMove{
      from{ transform: translateY(0); }
      to  { transform: translateY(24px); }
    }

    .startVignette{
      position:absolute; inset:0;
      pointer-events:none;
      background:
        radial-gradient(circle at 50% 40%, rgba(0,0,0,0) 32%, rgba(0,0,0,.55) 82%),
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.62));
    }

    /* Start UI now slimmer; on mobile we keep bg visible */
    .startUI{
      position:absolute;
      left:0; right:0; bottom:0;
      padding:12px 12px calc(12px + env(safe-area-inset-bottom));
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.70));
    }

    .pressStart{
      font-size:14px;
      letter-spacing:1px;
      color: #eaffff;
      text-shadow:
        0 0 10px rgba(125,249,255,.55),
        0 0 22px rgba(125,249,255,.35),
        0 10px 35px rgba(0,0,0,.55);
      animation: neonPulse 1.1s ease-in-out infinite;
      user-select:none;
      margin-bottom: 2px;
    }
    @keyframes neonPulse{
      0%,100%{ transform: translateY(0); filter: brightness(1); opacity:1; }
      50%{ transform: translateY(-2px); filter: brightness(1.15); opacity:.92; }
    }

    .startHint{
      font-size:9px;
      color:var(--muted);
      text-shadow: 2px 2px 0 rgba(0,0,0,.45);
      line-height:1.6;
      text-align:center;
      opacity:.98;
      max-width: 560px;
    }

    /* ===== SHOP modal ===== */
    .shopModal{
      position:absolute; inset:0;
      z-index: 40;
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background: rgba(0,0,0,.42);
      backdrop-filter: blur(2px);
    }
    .shopModal.open{ display:flex; }

    .shop{
      width: min(560px, 100%);
      border:2px solid rgba(125,249,255,.55);
      background: rgba(12,8,24,.78);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--uiShadow);
      max-height: min(78vh, 620px);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .shopRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:stretch;
      margin-top: 8px;
    }

    .shopStat{
      flex:1;
      min-width: 220px;
      border:2px solid rgba(255,180,90,.65);
      border-radius: 12px;
      padding: 10px;
      font-size: 10px;
      background: rgba(20,12,40,.45);
      color: var(--muted);
      box-shadow: inset 0 0 22px rgba(255,160,60,.08);
      line-height: 1.55;
    }
    .shopStat b{ color: var(--txt); }

    .shopPanel{
      width: 100%;
      border:2px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius: 12px;
      padding: 10px;
      box-shadow: inset 0 0 18px rgba(125,249,255,.05);
    }

    .shopTitle{
      font-size: 10px;
      color: #eaffff;
      opacity: .95;
      margin-bottom: 8px;
      text-shadow: 2px 2px 0 rgba(0,0,0,.35);
      text-align: center;
    }

    .upgList{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }

    .upgItem{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border:2px solid rgba(255,180,90,.45);
      border-radius: 12px;
      padding: 10px;
      background: rgba(20,12,40,.35);
      box-shadow: inset 0 0 18px rgba(255,160,60,.06);
      font-size: 9px;
      color: var(--muted);
    }

    .upgItem .left{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width: 0;
    }
    .upgItem .name{
      color: var(--txt);
      font-size: 10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .upgItem .desc{
      opacity:.95;
      line-height:1.45;
    }
    .upgItem .right{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .badge{
      border:2px solid rgba(125,249,255,.55);
      border-radius: 10px;
      padding: 6px 8px;
      color: #eaffff;
      background: rgba(10,8,20,.35);
      font-size: 9px;
      min-width: 68px;
      text-align:center;
      box-shadow: inset 0 0 14px rgba(125,249,255,.08);
    }
    .btnSmall{
      flex:0 0 auto;
      min-width: 86px;
      padding: 10px 10px;
      font-size: 9px;
    }

    /* ===== Start footer buttons ===== */
    .startActions{
      width:min(560px, 100%);
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:stretch;
      flex-wrap:wrap;
    }
    .startActions button{
      flex: 1 1 160px;
      min-width: 140px;
    }
    .ghost{
      border-color: rgba(255,255,255,.22);
      color: rgba(255,246,230,.92);
    }

    .shopBtns button{ min-width: 120px; }

    .shopSmall{
      font-size: 8px;
      color: rgba(255,217,166,.92);
      line-height: 1.55;
      text-align:center;
      margin-top: 6px;
      opacity: .98;
    }

    .pop{
      position:absolute;
      font-size:10px;
      color: var(--warn);
      text-shadow: 2px 2px 0 rgba(0,0,0,.45);
      animation: pop 700ms ease-out forwards;
      pointer-events:none;
      z-index: 10;
      will-change: transform, opacity;
    }
    @keyframes pop{
      from{ transform: translateY(0); opacity:1; }
      to{ transform: translateY(-18px); opacity:0; }
    }

    .touchHint{
      position:absolute;
      left:0; top:0;
      transform: translate(-50%, 0);
      pointer-events:none;
      display:none;
      text-align:center;
      z-index:7;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));
    }
    .touchHint .hintHand{ font-size:18px; animation: hintBob .9s ease-in-out infinite; }
    .touchHint .hintArrow{ font-size:14px; opacity:.9; animation: hintBob 1.1s ease-in-out infinite; }
    .touchHint .hintText{
      margin-top:4px;
      font-size:8px;
      color: var(--warn);
      text-shadow: 2px 2px 0 rgba(0,0,0,.45);
    }
    @keyframes hintBob{
      0%,100%{ transform: translateY(0); }
      50%{ transform: translateY(6px); }
    }

    /* ===== Mobile optimization: show more startBg, compact buttons ===== */
    @media (max-width: 600px){
      body{
        padding:0 !important;
        overflow:auto;
        -webkit-overflow-scrolling:touch;
        display:block;
      }
      .card{
        padding:10px;
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
        display:flex;
        flex-direction:column;
        gap:10px;
      }
      .game{
        aspect-ratio:auto;
        height:calc(100vh - 165px);
        max-height:none;
      }
      .help{ display:none; }

      .pill{ min-width: 150px; font-size:9px; padding:9px 9px; }
      button{ padding:10px 10px; font-size:9px; border-radius:12px; }

      .startUI{
        padding:10px 10px calc(10px + env(safe-area-inset-bottom));
        gap:8px;
        background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.62));
      }
      .pressStart{ font-size:13px; }
      .startHint{ font-size:8px; line-height:1.55; opacity:.98; }

      .startActions{ gap:8px; }
      .startActions button{ flex: 1 1 120px; min-width: 120px; }

      .shop{
        padding:10px;
        max-height: 74vh;
      }
      .shopStat{ min-width: 160px; font-size:9px; padding:9px; }
      .upgItem{ padding:9px; }
      .upgItem .name{ font-size:9px; }
      .upgItem .desc{ font-size:8px; }
      .badge{ min-width: 62px; font-size:8px; padding:6px 7px; }
      .btnSmall{ min-width: 78px; padding:9px 9px; font-size:8px; }
      .shopBtns button{ min-width: 0; }
    }
  </style>
</head>

<body>
  <div class="posterGrid"></div>
  <div class="grain"></div>

  <div class="wrap">
    <div class="title">
      <h1>XGP ì±„êµ´ê²Œì„</h1>
      <div class="mini">A / D ë˜ëŠ” ë“œë˜ê·¸</div>
    </div>

    <div class="card">
      <div class="hud">
        <div class="pill">ì‹œê°„: <b id="time">0.0</b>s</div>
        <div class="pill">ì ìˆ˜: <b id="score">0</b></div>
        <div class="pill">ë ˆë²¨: <b id="level">0</b>/100</div>
        <div class="pill">STAR: <b id="bank">0</b></div>
        <div class="pill">ìµœê³ : <b id="best">0</b></div>
      </div>

      <div class="game" id="game" aria-label="game">
        <div class="spaceLayer" aria-hidden="true"></div>
        <div class="streak s1" aria-hidden="true"></div>
        <div class="streak s2" aria-hidden="true"></div>

        <div class="player" id="player" aria-label="jet">
          <div class="jetSprite" id="jetSprite"></div>
        </div>

        <div class="touchHint" id="touchHint" aria-hidden="true">
          <div class="hintHand">ğŸ‘‡</div>
          <div class="hintArrow">â¬‡ï¸</div>
          <div class="hintText">ë“œë˜ê·¸!</div>
        </div>

        <!-- ì‹œì‘ í™”ë©´ -->
        <div class="overlay" id="overlay">
          <div class="startBg" id="startBg"></div>
          <div class="scanlines"></div>
          <div class="startVignette"></div>

          <div class="startUI">
            <div class="pressStart">PRESS START</div>

            <div class="startHint">
              ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ(ê¸°ì¡´ ë°©ì‹ ìœ ì§€): <b>100 STAR = 1 ë ˆë²¨</b> (ìµœëŒ€ 100)<br/>
              ì¶”ê°€ ì—…ê·¸ë ˆì´ë“œ: ì ìˆ˜ë°°ìˆ˜ / ì´ë™ì†ë„ / íˆíŠ¸ë°•ìŠ¤ ì¶•ì†Œ / ë³„ ì¶œí˜„ë¥  / í­íƒ„ ì†ë„ ê°ì†Œ<br/>
              í­íƒ„ì€ <b>ê²½ê³  ë¼ì¸</b> í›„ì— ë–¨ì–´ì§€ëŠ” íŒ¨í„´ì´ ì„ì—¬ì„œ í€„ë¦¬í‹°ê°€ í™• ì˜¬ë¼ê°€.
            </div>

            <div class="startActions">
              <button id="openShopBtn" class="ghost">SHOP ì—´ê¸°</button>
              <button id="startBtn" class="primary">ì‹œì‘í•˜ê¸°</button>
            </div>
          </div>

          <!-- SHOP ëª¨ë‹¬ (ëª¨ë°”ì¼: ê¸°ë³¸ ë‹«í˜ / PC: ì—´ì–´ë„ ë¨) -->
          <div class="shopModal" id="shopModal" role="dialog" aria-modal="true" aria-label="shop modal">
            <div class="shop" role="group" aria-label="shop">
              <div class="shopRow" style="margin-top:0;">
                <div class="shopStat">
                  ë³´ìœ  STAR: <b id="shopBank">0</b><br/>
                  êµ¬ë§¤ ë ˆë²¨: <b id="shopLevel">0</b>/100
                </div>
                <div class="shopStat">
                  ì ìˆ˜ë°°ìˆ˜: <b id="shopMul">x1.00</b><br/>
                  ì´ë™ì†ë„: <b id="shopMove">x1.00</b><br/>
                  íˆíŠ¸ë°•ìŠ¤: <b id="shopHit">100%</b><br/>
                  ë³„ ì¶œí˜„ë¥ : <b id="shopStarRate">x1.00</b><br/>
                  í­íƒ„ ì†ë„: <b id="shopHazSlow">100%</b>
                </div>
              </div>

              <div class="shopRow">
                <div class="shopPanel">
                  <div class="shopTitle">UPGRADE SHOP (ê° +1 = 100 STAR)</div>

                  <div class="upgList">
                    <div class="upgItem">
                      <div class="left">
                        <div class="name">ë ˆë²¨ ì—…ê·¸ë ˆì´ë“œ</div>
                        <div class="desc">ê¸°ë³¸ ë°°ìˆ˜(1.05^ë ˆë²¨) ìƒìŠ¹ + 10ë‹¨ìœ„ë§ˆë‹¤ ìŠ¤í‚¨ ì§„í™”</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="lvNow">0</span>/100</div>
                        <button class="btnSmall primary" id="buyLv">+1</button>
                      </div>
                    </div>

                    <div class="upgItem">
                      <div class="left">
                        <div class="name">ì ìˆ˜ ë°°ìˆ˜</div>
                        <div class="desc">ë³„ íšë“ ì ìˆ˜ ì¶”ê°€ ë°°ìˆ˜ (ì—…ê·¸ë ˆì´ë“œ 1ë‹¹ +3%)</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="mulNow">0</span>/50</div>
                        <button class="btnSmall primary" id="buyMul">+1</button>
                      </div>
                    </div>

                    <div class="upgItem">
                      <div class="left">
                        <div class="name">ì´ë™ ì†ë„</div>
                        <div class="desc">ì¢Œìš° ì´ë™ ì†ë„ ì¦ê°€ (ì—…ê·¸ë ˆì´ë“œ 1ë‹¹ +2%)</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="moveNow">0</span>/50</div>
                        <button class="btnSmall primary" id="buyMove">+1</button>
                      </div>
                    </div>

                    <div class="upgItem">
                      <div class="left">
                        <div class="name">íˆíŠ¸ë°•ìŠ¤ ì¶•ì†Œ</div>
                        <div class="desc">ì¶©ëŒ íŒì • ì¶•ì†Œ (ì—…ê·¸ë ˆì´ë“œ 1ë‹¹ -0.6%)</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="hitNow">0</span>/60</div>
                        <button class="btnSmall primary" id="buyHit">+1</button>
                      </div>
                    </div>

                    <div class="upgItem">
                      <div class="left">
                        <div class="name">ë³„ ì¶œí˜„ë¥ </div>
                        <div class="desc">ë³„ ë” ìì£¼ ë“±ì¥ (ì—…ê·¸ë ˆì´ë“œ 1ë‹¹ +2.5%)</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="starNow">0</span>/50</div>
                        <button class="btnSmall primary" id="buyStarRate">+1</button>
                      </div>
                    </div>

                    <div class="upgItem">
                      <div class="left">
                        <div class="name">í­íƒ„ ì†ë„ ê°ì†Œ</div>
                        <div class="desc">í­íƒ„ ë‚™í•˜ ì†ë„ ê°ì†Œ (ì—…ê·¸ë ˆì´ë“œ 1ë‹¹ -1.3%)</div>
                      </div>
                      <div class="right">
                        <div class="badge"><span id="slowNow">0</span>/50</div>
                        <button class="btnSmall primary" id="buyHazSlow">+1</button>
                      </div>
                    </div>
                  </div>

                  <div class="shopRow shopBtns" style="margin-top:10px;">
                    <button id="buy10pack" class="primary">+10 íŒ¨í‚¤ì§€</button>
                    <button id="buyMax" class="primary">ë ˆë²¨ MAX</button>
                    <button id="resetShop" class="danger">ëª¨ë‘ ì´ˆê¸°í™”</button>
                    <button id="closeShopBtn" class="ghost">ë‹«ê¸°</button>
                  </div>

                  <div class="shopSmall">
                    íŒ: HARDì—ì„œ ê²½ê³  í›„ ë‚™í•˜(í…”ë ˆê·¸ë˜í”„) íŒ¨í„´ì´ ë” ìì£¼ ë‚˜ì˜´. ìŠ¤í”Œë¦¬í„°/ì‹œì»¤ ë“± íŠ¹ìˆ˜ í­íƒ„ë„ ê°•í™”.
                  </div>
                </div>
              </div>
            </div>
          </div><!-- shopModal -->
        </div><!-- overlay -->
      </div><!-- game -->

      <div class="btnRow">
        <button id="restartBtn">ë¦¬ì…‹(ëŸ°)</button>
        <button id="hardBtn" class="primary">ë‚œì´ë„: EASY</button>
      </div>

      <div class="help">
        ì¡°ì‘: PCëŠ” A/D(ì¢Œìš°) ë˜ëŠ” ë°©í–¥í‚¤, ëª¨ë°”ì¼ì€ ì œíŠ¸ê¸°ë¥¼ ë“œë˜ê·¸<br/>
        ëª©í‘œ: í­íƒ„ í”¼í•˜ê³  ë³„ì„ ë¨¹ì–´ ì ìˆ˜ íšë“. (ì—…ê·¸ë ˆì´ë“œëŠ” ì‹œì‘ ì „ì—!)
      </div>
    </div>
  </div>

  <script>
    // ===== DOM =====
    const game = document.getElementById("game");
    const player = document.getElementById("player");
    const jetSprite = document.getElementById("jetSprite");

    const overlay = document.getElementById("overlay");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const hardBtn = document.getElementById("hardBtn");
    const touchHint = document.getElementById("touchHint");
    const startBg = document.getElementById("startBg");

    const openShopBtn = document.getElementById("openShopBtn");
    const closeShopBtn = document.getElementById("closeShopBtn");
    const shopModal = document.getElementById("shopModal");

    const timeEl = document.getElementById("time");
    const scoreEl = document.getElementById("score");
    const levelEl = document.getElementById("level");
    const bestEl = document.getElementById("best");
    const bankEl = document.getElementById("bank");

    const shopBankEl = document.getElementById("shopBank");
    const shopLevelEl = document.getElementById("shopLevel");
    const shopMulEl = document.getElementById("shopMul");
    const shopMoveEl = document.getElementById("shopMove");
    const shopHitEl = document.getElementById("shopHit");
    const shopStarRateEl = document.getElementById("shopStarRate");
    const shopHazSlowEl = document.getElementById("shopHazSlow");

    const lvNowEl = document.getElementById("lvNow");
    const mulNowEl = document.getElementById("mulNow");
    const moveNowEl = document.getElementById("moveNow");
    const hitNowEl = document.getElementById("hitNow");
    const starNowEl = document.getElementById("starNow");
    const slowNowEl = document.getElementById("slowNow");

    const buyLvBtn = document.getElementById("buyLv");
    const buyMulBtn = document.getElementById("buyMul");
    const buyMoveBtn = document.getElementById("buyMove");
    const buyHitBtn = document.getElementById("buyHit");
    const buyStarRateBtn = document.getElementById("buyStarRate");
    const buyHazSlowBtn = document.getElementById("buyHazSlow");

    const buy10packBtn = document.getElementById("buy10pack");
    const buyMaxBtn = document.getElementById("buyMax");
    const resetShopBtn = document.getElementById("resetShop");

    // ===== Assets =====
    const START_SCREEN_URL =
      "https://github.com/ttjdwls777-eng/-/blob/main/%EA%B2%8C%EC%9E%84%EC%8B%9C%EC%9E%91%20%ED%99%94%EB%A9%B4.png?raw=1";

    function jetSkinSvg({ body="#7df9ff", wing="#ffd166", core="#ffffff", flame="#ff6a3d", accent="#7b2cff" }){
      return "data:image/svg+xml," + encodeURIComponent(`
        <svg xmlns="http://www.w3.org/2000/svg" width="96" height="96" viewBox="0 0 96 96">
          <defs>
            <linearGradient id="g" x1="0" x2="1">
              <stop offset="0" stop-color="${body}" stop-opacity="0.95"/>
              <stop offset="1" stop-color="${accent}" stop-opacity="0.95"/>
            </linearGradient>
            <radialGradient id="c" cx="45%" cy="40%" r="70%">
              <stop offset="0" stop-color="${core}" stop-opacity="0.95"/>
              <stop offset="1" stop-color="${body}" stop-opacity="0.85"/>
            </radialGradient>
          </defs>

          <path d="M16 54 L42 42 L42 56 L16 64 Z" fill="${wing}" opacity="0.95"/>
          <path d="M80 54 L54 42 L54 56 L80 64 Z" fill="${wing}" opacity="0.95"/>

          <path d="M48 10 L60 36 L60 70 L48 82 L36 70 L36 36 Z" fill="url(#g)" stroke="${core}" stroke-opacity="0.85" stroke-width="3"/>
          <circle cx="48" cy="44" r="10" fill="url(#c)" stroke="${core}" stroke-opacity="0.55" stroke-width="2"/>

          <path d="M48 18 L54 34 L48 38 L42 34 Z" fill="${core}" opacity="0.55"/>
          <path d="M48 86 C54 82 56 78 48 72 C40 78 42 82 48 86 Z" fill="${flame}" opacity="0.92"/>

          <rect x="26" y="30" width="3" height="3" fill="${core}" opacity="0.65"/>
          <rect x="67" y="31" width="3" height="3" fill="${core}" opacity="0.55"/>
          <rect x="30" y="66" width="3" height="3" fill="${core}" opacity="0.45"/>
        </svg>
      `);
    }

    const JET_SKINS = [
      jetSkinSvg({ body:"#7df9ff", wing:"#ffd166", core:"#ffffff", flame:"#ff6a3d", accent:"#2a55ff" }),
      jetSkinSvg({ body:"#67ff6d", wing:"#eaffff", core:"#ffffff", flame:"#ffd166", accent:"#00c2a8" }),
      jetSkinSvg({ body:"#ffd166", wing:"#7df9ff", core:"#ffffff", flame:"#ff6a3d", accent:"#ff2cc8" }),
      jetSkinSvg({ body:"#ff4dff", wing:"#ffd166", core:"#ffffff", flame:"#7df9ff", accent:"#6b00ff" }),
      jetSkinSvg({ body:"#ff6a3d", wing:"#fff4b3", core:"#ffffff", flame:"#ffd166", accent:"#ff2a2a" }),
      jetSkinSvg({ body:"#ffffff", wing:"#7df9ff", core:"#ffd166", flame:"#ff4dff", accent:"#00ffcc" }),
    ];

    const STAR_SVG =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 96 96'%3E%3Cdefs%3E%3CradialGradient id='s' cx='50%25' cy='35%25' r='70%25'%3E%3Cstop offset='0%25' stop-color='%23fff4b3'/%3E%3Cstop offset='55%25' stop-color='%23ffd166'/%3E%3Cstop offset='100%25' stop-color='%23ff9a3c'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cpath d='M48 6l11 24 26 3-19 18 5 26-23-13-23 13 5-26L11 33l26-3z' fill='url(%23s)' stroke='%23ffffff' stroke-opacity='.85' stroke-width='3'/%3E%3C/svg%3E";

    // 8 hazard types
    const HAZARD_TYPES = [
      { key:"core", cls:"", w:36, h:36, hit:0.62, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 96 96'%3E%3Cdefs%3E%3CradialGradient id='g' cx='30%25' cy='25%25' r='70%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='.65'/%3E%3Cstop offset='40%25' stop-color='%235b2bbf' stop-opacity='1'/%3E%3Cstop offset='100%25' stop-color='%23210a4f' stop-opacity='1'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='48' cy='48' r='30' fill='url(%23g)' stroke='%23ffffff' stroke-opacity='.9' stroke-width='4'/%3E%3Cpath d='M28 44c10-12 18 12 28 0s18 12 28 0' fill='none' stroke='%237df9ff' stroke-opacity='.65' stroke-width='3'/%3E%3Cpath d='M30 60c12-10 14 10 26 0s16 10 26 0' fill='none' stroke='%23ffd166' stroke-opacity='.45' stroke-width='2.5'/%3E%3C/svg%3E" },
      { key:"mine", cls:"", w:40, h:40, hit:0.58, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='110' height='110' viewBox='0 0 110 110'%3E%3Cdefs%3E%3CradialGradient id='m' cx='35%25' cy='30%25' r='70%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='.75'/%3E%3Cstop offset='40%25' stop-color='%232aa7ff'/%3E%3Cstop offset='100%25' stop-color='%230b2b66'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cpath d='M55 6l7 18 16-10-6 19 19 2-14 12 16 10-19 1 6 19-16-10-7 18-7-18-16 10 6-19-19-1 16-10-14-12 19-2-6-19 16 10z' fill='%23d7f5ff' opacity='.55'/%3E%3Ccircle cx='55' cy='55' r='28' fill='url(%23m)' stroke='%23ffffff' stroke-opacity='.9' stroke-width='4'/%3E%3Cpath d='M36 60c9-9 15 9 24 0s15 9 24 0' fill='none' stroke='%23ffd166' stroke-opacity='.45' stroke-width='3'/%3E%3C/svg%3E" },
      { key:"comet", cls:"spin", w:54, h:22, hit:0.72, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='80' viewBox='0 0 180 80'%3E%3Cdefs%3E%3ClinearGradient id='c' x1='0' x2='1'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='0'/%3E%3Cstop offset='.35' stop-color='%23ffd166' stop-opacity='.35'/%3E%3Cstop offset='1' stop-color='%23ff6a3d'/%3E%3C/linearGradient%3E%3CradialGradient id='h' cx='55%25' cy='40%25' r='70%25'%3E%3Cstop offset='0' stop-color='%23ffffff'/%3E%3Cstop offset='.55' stop-color='%23ff6a3d'/%3E%3Cstop offset='1' stop-color='%236a0f1f'/%3E%3C/radialGradient%3E%3C/defs%3E%3Cpath d='M12 40c40-24 74-26 112 0-38 26-72 24-112 0z' fill='url(%23c)'/%3E%3Ccircle cx='136' cy='40' r='22' fill='url(%23h)' stroke='%23ffffff' stroke-opacity='.85' stroke-width='4'/%3E%3C/svg%3E" },
      { key:"bigcore", cls:"", w:58, h:58, hit:0.62, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140' viewBox='0 0 140 140'%3E%3Cdefs%3E%3CradialGradient id='b' cx='30%25' cy='25%25' r='70%25'%3E%3Cstop offset='0%25' stop-color='%23ffffff' stop-opacity='.7'/%3E%3Cstop offset='40%25' stop-color='%23ff4dff'/%3E%3Cstop offset='100%25' stop-color='%23210a4f' stop-opacity='1'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='70' cy='74' r='44' fill='url(%23b)' stroke='%23ffffff' stroke-opacity='.9' stroke-width='5'/%3E%3Cpath d='M36 66c12-14 22 14 34 0s22 14 34 0' fill='none' stroke='%237df9ff' stroke-opacity='.65' stroke-width='4'/%3E%3C/svg%3E" },
      { key:"plasma", cls:"spin", w:26, h:26, hit:0.68, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 96 96'%3E%3Cdefs%3E%3CradialGradient id='p' cx='40%25' cy='35%25' r='70%25'%3E%3Cstop offset='0' stop-color='%23ffffff'/%3E%3Cstop offset='.55' stop-color='%237df9ff'/%3E%3Cstop offset='1' stop-color='%23073a5a'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='48' cy='48' r='22' fill='url(%23p)' stroke='%23ffffff' stroke-opacity='.75' stroke-width='4'/%3E%3Cpath d='M30 50c6-8 12 8 18 0s12 8 18 0' fill='none' stroke='%23ffd166' stroke-opacity='.35' stroke-width='2.5'/%3E%3C/svg%3E" },
      { key:"twister", cls:"", w:34, h:34, hit:0.62, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='110' height='110' viewBox='0 0 110 110'%3E%3Cdefs%3E%3CradialGradient id='t' cx='35%25' cy='30%25' r='75%25'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.7'/%3E%3Cstop offset='.55' stop-color='%23ffd166'/%3E%3Cstop offset='1' stop-color='%235b2bbf'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='55' cy='55' r='26' fill='url(%23t)' stroke='%23ffffff' stroke-opacity='.85' stroke-width='4'/%3E%3Cpath d='M30 55c8-10 14 10 22 0s14 10 22 0' fill='none' stroke='%237df9ff' stroke-opacity='.55' stroke-width='3'/%3E%3C/svg%3E" },
      { key:"splitter", cls:"", w:42, h:42, hit:0.60, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Cdefs%3E%3CradialGradient id='s' cx='35%25' cy='30%25' r='75%25'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.75'/%3E%3Cstop offset='.55' stop-color='%23ff4dff'/%3E%3Cstop offset='1' stop-color='%230b2b66'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='60' cy='60' r='30' fill='url(%23s)' stroke='%23ffffff' stroke-opacity='.85' stroke-width='4'/%3E%3Cpath d='M60 30v60' stroke='%23ffd166' stroke-opacity='.75' stroke-width='5'/%3E%3Cpath d='M38 60h44' stroke='%237df9ff' stroke-opacity='.55' stroke-width='4'/%3E%3C/svg%3E" },
      { key:"seeker", cls:"spin", w:32, h:32, hit:0.64, svg:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='96' height='96' viewBox='0 0 96 96'%3E%3Cdefs%3E%3CradialGradient id='q' cx='35%25' cy='30%25' r='75%25'%3E%3Cstop offset='0' stop-color='%23ffffff' stop-opacity='.75'/%3E%3Cstop offset='.55' stop-color='%2367ff6d'/%3E%3Cstop offset='1' stop-color='%23073a5a'/%3E%3C/radialGradient%3E%3C/defs%3E%3Ccircle cx='48' cy='48' r='24' fill='url(%23q)' stroke='%23ffffff' stroke-opacity='.85' stroke-width='4'/%3E%3Cpath d='M48 20l6 10-6 4-6-4z' fill='%23ffffff' opacity='.55'/%3E%3Cpath d='M30 58c10-8 12 8 18 0s12 8 18 0' fill='none' stroke='%23ffd166' stroke-opacity='.45' stroke-width='3'/%3E%3C/svg%3E" },
    ];

    // ===== Collision base (will be modified by upgrades) =====
    const STAR_HIT_SCALE   = 0.85;
    const BASE_PLAYER_HIT  = 0.82;

    // ===== AUDIO =====
    let audioCtx = null;
    let audioReady = null;

    function ensureAudioReady(){
      if (!audioReady) audioReady = initAudio();
      return audioReady;
    }
    async function initAudio(){
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state !== "running") {
        try { await audioCtx.resume(); } catch(e) {}
      }
    }
    function beep({ freq=440, dur=0.08, type="square", vol=0.18, endFreq=null } = {}){
      if (!audioCtx || audioCtx.state !== "running") return;
      const t = audioCtx.currentTime;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = type;
      osc.frequency.setValueAtTime(freq, t);
      if (endFreq != null) osc.frequency.exponentialRampToValueAtTime(Math.max(40, endFreq), t + dur);

      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(vol, t + 0.01);
      gain.gain.exponentialRampToValueAtTime(0.0001, t + dur);

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start(t);
      osc.stop(t + dur + 0.02);
    }
    function sfxStart(){
      ensureAudioReady().then(() => {
        beep({ freq: 523, dur: 0.06, type:"square", vol:0.12 });
        setTimeout(() => beep({ freq: 659, dur: 0.07, type:"square", vol:0.12 }), 70);
      }).catch(()=>{});
    }
    function sfxCoin(){
      ensureAudioReady().then(() => {
        beep({ freq: 880, dur: 0.05, type:"triangle", vol:0.10, endFreq: 1200 });
      }).catch(()=>{});
    }
    function sfxOver(){
      ensureAudioReady().then(() => {
        beep({ freq: 140, dur: 0.10, type:"square",  vol:0.28, endFreq: 70 });
        setTimeout(() => beep({ freq: 90, dur: 0.12, type:"sawtooth", vol:0.22, endFreq: 40 }), 70);
      }).catch(()=>{});
    }
    function sfxBuy(){
      ensureAudioReady().then(() => {
        beep({ freq: 988, dur: 0.05, type:"triangle", vol:0.10 });
        setTimeout(() => beep({ freq: 1319, dur: 0.06, type:"triangle", vol:0.10 }), 70);
      }).catch(()=>{});
    }
    function sfxWarn(){
      ensureAudioReady().then(() => {
        beep({ freq: 740, dur: 0.05, type:"square", vol:0.06 });
      }).catch(()=>{});
    }

    // ===== GAME STATE =====
    let running = false;
    let raf = null;
    let lastTime = 0;
    let startAt = 0;

    const isMobile = matchMedia("(max-width: 600px)").matches;
    const pSize = isMobile ? 62 : 56;

    const modes = [
      { name:"EASY", hazardRate: 520, hazardSpeed: 250, starRate: 980, starSpeed: 165, zigzag:false, telegraphChance: 0.18 },
      { name:"HARD", hazardRate: 360, hazardSpeed: 330, starRate: 1150, starSpeed: 195, zigzag:true,  telegraphChance: 0.38 }
    ];
    let modeIdx = 0;

    let gW = 0, gH = 0;
    let px = 0, py = 0;
    let lastPx = 0;

    let scorePoints = 0;
    let level = 0;

    // ===== Economy & Upgrades =====
    const LS_BANK = "xgp_bank_v2";
    const LS_BEST = "xgp_best_v7";

    const LS_LV = "xgp_upgrade_level_v2"; // 0~100
    const LS_MUL  = "xgp_upg_mul_v1";     // 0~50
    const LS_MOVE = "xgp_upg_move_v1";    // 0~50
    const LS_HIT  = "xgp_upg_hit_v1";     // 0~60
    const LS_STAR = "xgp_upg_star_v1";    // 0~50
    const LS_SLOW = "xgp_upg_slow_v1";    // 0~50

    function loadInt(key, def=0){
      const v = localStorage.getItem(key);
      const n = Number(v ?? def);
      return Number.isFinite(n) ? Math.floor(n) : def;
    }
    function saveInt(key, n){ localStorage.setItem(key, String(Math.floor(n))); }

    function loadBank(){
      const v = localStorage.getItem(LS_BANK);
      if (v == null){
        localStorage.setItem(LS_BANK, String(10000));
        return 10000;
      }
      const n = Number(v);
      return Number.isFinite(n) ? Math.max(0, Math.floor(n)) : 10000;
    }
    function saveBank(n){ localStorage.setItem(LS_BANK, String(Math.max(0, Math.floor(n)))); }

    let bank = loadBank();

    let upgLevel = clamp(loadInt(LS_LV, 0), 0, 100);
    let upgMul   = clamp(loadInt(LS_MUL, 0), 0, 50);
    let upgMove  = clamp(loadInt(LS_MOVE,0), 0, 50);
    let upgHit   = clamp(loadInt(LS_HIT, 0), 0, 60);
    let upgStar  = clamp(loadInt(LS_STAR,0), 0, 50);
    let upgSlow  = clamp(loadInt(LS_SLOW,0), 0, 50);

    level = upgLevel;

    let best = Number(localStorage.getItem(LS_BEST) || 0);
    bestEl.textContent = best;

    function scoreBonusMultiplier(){ return 1 + upgMul * 0.03; }
    function moveSpeedMultiplier(){ return 1 + upgMove * 0.02; }
    function playerHitScale(){
      const scale = BASE_PLAYER_HIT * (1 - upgHit * 0.006);
      return clamp(scale, 0.42, 0.95);
    }
    function starRateMultiplier(){ return 1 + upgStar * 0.025; }
    function hazardSpeedMultiplier(){
      const mul = 1 - upgSlow * 0.013;
      return clamp(mul, 0.35, 1.0);
    }

    // ===== Tier visuals =====
    const JET_TIERS = [
      { auraHue:"190deg", auraA:0.18, auraB:0.08, ringHue:"190deg", ringA:0.18, trailHue:"190deg", trailA:0.55, particleRate: 90, filter:"saturate(1.1) contrast(1.05) brightness(1.05)"},
      { auraHue:"70deg",  auraA:0.30, auraB:0.14, ringHue:"70deg",  ringA:0.26, trailHue:"70deg",  trailA:0.70, particleRate: 65, filter:"saturate(2.4) contrast(1.25) brightness(1.12)"},
      { auraHue:"160deg", auraA:0.36, auraB:0.18, ringHue:"160deg", ringA:0.30, trailHue:"160deg", trailA:0.82, particleRate: 55, filter:"saturate(2.9) contrast(1.35) brightness(1.18)"},
      { auraHue:"255deg", auraA:0.42, auraB:0.22, ringHue:"255deg", ringA:0.34, trailHue:"255deg", trailA:0.92, particleRate: 45, filter:"saturate(3.3) contrast(1.45) brightness(1.22)"},
      { auraHue:"330deg", auraA:0.48, auraB:0.26, ringHue:"330deg", ringA:0.38, trailHue:"330deg", trailA:1.00, particleRate: 38, filter:"saturate(3.8) contrast(1.55) brightness(1.25)"},
      { auraHue:"120deg", auraA:0.55, auraB:0.30, ringHue:"120deg", ringA:0.44, trailHue:"120deg", trailA:1.10, particleRate: 32, filter:"saturate(4.2) contrast(1.65) brightness(1.30)"},
    ];
    let lastTier = -1;

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
    function currentTier(){
      const t = Math.floor(level / 10);
      return clamp(t, 0, JET_TIERS.length - 1);
    }
    function tierSkinIndex(){
      const t = Math.floor(level / 10);
      return clamp(t, 0, JET_SKINS.length - 1);
    }
    function applyJetTier(force=false){
      const t = currentTier();
      if (!force && t === lastTier) return;
      lastTier = t;

      const conf = JET_TIERS[t];

      document.documentElement.style.setProperty("--jetAuraHue", conf.auraHue);
      document.documentElement.style.setProperty("--jetAuraA", String(conf.auraA));
      document.documentElement.style.setProperty("--jetAuraB", String(conf.auraB));
      document.documentElement.style.setProperty("--jetRingHue", conf.ringHue);
      document.documentElement.style.setProperty("--jetRingA", String(conf.ringA));
      document.documentElement.style.setProperty("--trailHue", conf.trailHue);
      document.documentElement.style.setProperty("--trailA", String(conf.trailA));

      jetSprite.style.backgroundImage = `url("${JET_SKINS[tierSkinIndex()]}")`;
      jetSprite.style.filter = conf.filter + " drop-shadow(0 0 14px rgba(125,249,255,.22))";

      jetSprite.style.transform = "scale(1.06)";
      setTimeout(()=> { jetSprite.style.transform = "scale(1.0)"; }, 120);
    }

    // ===== Objects arrays =====
    const hazards = [];
    const stars = [];
    const warnings = [];

    let hazardTimer = null;
    let starTimer = null;
    let warnTimer = null;

    // ===== Utils =====
    function measureGame(){
      const r = game.getBoundingClientRect();
      gW = r.width;
      gH = r.height;
    }

    function setPlayerX(x){
      px = clamp(Math.round(x), 0, Math.round(gW - pSize));
      const dx = px - lastPx;
      lastPx = px;
      const tilt = clamp(dx * 0.55, -14, 14);
      player.style.transform = `translate3d(${px}px, ${py}px, 0) rotate(${tilt}deg)`;
    }
    function positionPlayer(){
      py = Math.round(gH * 0.74);
      player.style.width = pSize + "px";
      player.style.height = pSize + "px";
      player.style.transform = `translate3d(${px}px, ${py}px, 0) rotate(0deg)`;
      lastPx = px;
    }
    function showTouchHint(show){
      touchHint.style.display = show ? "block" : "none";
      if (!show) return;
      touchHint.style.left = Math.round(px + pSize/2) + "px";
      touchHint.style.top  = Math.round(py + pSize + 8) + "px";
    }

    function popText(x, y, text){
      const el = document.createElement("div");
      el.className = "pop";
      el.textContent = text;
      el.style.left = Math.round(x) + "px";
      el.style.top = Math.round(y) + "px";
      game.appendChild(el);
      setTimeout(()=> el.remove(), 750);
    }

    function spawnExplosion(x, y){
      const ex = document.createElement("div");
      ex.className = "explosion";
      ex.style.left = Math.round(x) + "px";
      ex.style.top  = Math.round(y) + "px";
      game.appendChild(ex);
      setTimeout(() => ex.remove(), 520);
    }

    function spawnTierRing(){
      const r = document.createElement("div");
      r.className = "tierRing";
      r.style.left = Math.round(px + pSize/2) + "px";
      r.style.top  = Math.round(py + pSize/2) + "px";
      game.appendChild(r);
      setTimeout(()=> r.remove(), 620);
    }

    function aabbScaled(ax, ay, aw, ah, as, bx, by, bw, bh, bs){
      const aW = aw * as, aH = ah * as;
      const bW = bw * bs, bH = bh * bs;

      const aX = ax + (aw - aW)/2;
      const aY = ay + (ah - aH)/2;

      const bX = bx + (bw - bW)/2;
      const bY = by + (bh - bH)/2;

      return !(aX + aW < bX || aX > bX + bW || aY + aH < bY || aY > bY + bH);
    }

    // ===== Gameplay multipliers =====
    function gainMultiplier(){
      return Math.pow(1.05, level) * scoreBonusMultiplier();
    }

    // ===== Spawning =====
    function pickHazardType(){
      const t = currentTier();
      const r = Math.random();
      const weightsByTier = [
        [0.40, 0.22, 0.10, 0.08, 0.08, 0.06, 0.04, 0.02],
        [0.30, 0.18, 0.12, 0.10, 0.10, 0.08, 0.07, 0.05],
        [0.22, 0.14, 0.14, 0.12, 0.12, 0.10, 0.09, 0.07],
        [0.18, 0.12, 0.15, 0.13, 0.13, 0.11, 0.10, 0.08],
        [0.14, 0.10, 0.16, 0.14, 0.14, 0.12, 0.11, 0.09],
      ];
      const w = weightsByTier[Math.min(t, weightsByTier.length - 1)];

      let acc = 0;
      for (let i=0;i<w.length;i++){
        acc += w[i];
        if (r <= acc) return HAZARD_TYPES[i];
      }
      return HAZARD_TYPES[0];
    }

    function spawnHazardAt(x, typeOverride=null, isTelegraphSpawn=false){
      const type = typeOverride || pickHazardType();

      const el = document.createElement("div");
      el.className = "hazard " + (type.cls || "");
      el.style.width = type.w + "px";
      el.style.height = type.h + "px";
      el.style.backgroundImage = `url("${type.svg}")`;

      const y = -180;
      const m = modes[modeIdx];
      const zig = m.zigzag;

      let vx = 0;
      if (zig) vx = (Math.random() < 0.5 ? -1 : 1) * (70 + Math.random()*120);

      if (type.key === "comet") vx = (Math.random() < 0.5 ? -1 : 1) * (140 + Math.random()*180);
      if (type.key === "plasma") vx = (Math.random() < 0.5 ? -1 : 1) * (90 + Math.random()*140);
      if (type.key === "twister") vx = (Math.random() < 0.5 ? -1 : 1) * (40 + Math.random()*60);

      const speedMul =
        (type.key === "bigcore") ? 0.92 :
        (type.key === "plasma") ? 1.20 :
        (type.key === "comet") ? 1.08 :
        1.00;

      const splitAt = (type.key === "splitter") ? (gH * (0.35 + Math.random()*0.25)) : null;

      const obj = {
        el,
        x: clamp(x, 0, gW - type.w),
        y,
        vx,
        w:type.w, h:type.h,
        hitScale:type.hit,
        speedMul,
        key:type.key,
        splitAt,
        didSplit:false,
        phase: Math.random()*Math.PI*2,
        tele: isTelegraphSpawn ? 1.12 : 1.0
      };

      hazards.push(obj);
      el.style.setProperty("--x", obj.x + "px");
      el.style.setProperty("--y", obj.y + "px");
      game.appendChild(el);
    }

    function spawnMini(x, y, dir){
      const type = HAZARD_TYPES[4]; // plasma mini
      const el = document.createElement("div");
      el.className = "hazard spin";
      el.style.width = type.w + "px";
      el.style.height = type.h + "px";
      el.style.backgroundImage = `url("${type.svg}")`;

      const obj = {
        el,
        x: clamp(x, 0, gW - type.w),
        y,
        vx: dir * (160 + Math.random()*140),
        w:type.w, h:type.h,
        hitScale: 0.70,
        speedMul: 1.15,
        key:"mini",
        splitAt:null,
        didSplit:true,
        phase: Math.random()*Math.PI*2,
        tele: 1.0
      };
      hazards.push(obj);

      el.style.setProperty("--x", obj.x + "px");
      el.style.setProperty("--y", obj.y + "px");
      game.appendChild(el);
    }

    function spawnStar(){
      const el = document.createElement("div");
      el.className = "star";
      el.style.backgroundImage = `url("${STAR_SVG}")`;

      const x = Math.random() * (gW - 28);
      const y = -120;

      const obj = { el, x, y, w:28, h:28 };
      stars.push(obj);

      el.style.setProperty("--x", x + "px");
      el.style.setProperty("--y", y + "px");
      game.appendChild(el);
    }

    // ===== Telegraph system =====
    function spawnTelegraph(){
      if (!running) return;

      const m = modes[modeIdx];
      const chance = m.telegraphChance + Math.min(0.22, currentTier()*0.04);
      if (Math.random() > chance) return;

      let x = Math.random() * (gW - 6);
      if (m.name === "HARD" && Math.random() < 0.55){
        x = (px + pSize/2) + (Math.random()*180 - 90);
      }
      x = clamp(x, 10, gW - 10);

      const line = document.createElement("div");
      line.className = "warnLine";
      line.style.setProperty("--x", Math.round(x) + "px");

      const circle = document.createElement("div");
      circle.className = "warnCircle";
      circle.style.left = Math.round(x) + "px";
      circle.style.top  = Math.round(gH * 0.30) + "px";

      game.appendChild(line);
      game.appendChild(circle);

      const warn = {
        line,
        circle,
        x,
        t: 0,
        duration: (m.name === "HARD" ? 720 : 860) - currentTier()*60,
        burst: (m.name === "HARD" && Math.random() < 0.35) ? 2 : 1
      };
      warnings.push(warn);
      sfxWarn();
    }

    // ===== Cleaning / Stop =====
    function clearObjects(){
      for (const o of hazards) o.el.remove();
      for (const o of stars) o.el.remove();
      for (const w of warnings){ w.line.remove(); w.circle.remove(); }
      hazards.length = 0;
      stars.length = 0;
      warnings.length = 0;
      [...game.querySelectorAll(".pop,.explosion,.jetParticle,.tierRing")].forEach(el => el.remove());
    }

    function stop(){
      running = false;
      if (raf) cancelAnimationFrame(raf);
      raf = null;
      if (hazardTimer){ clearInterval(hazardTimer); hazardTimer = null; }
      if (starTimer){ clearInterval(starTimer); starTimer = null; }
      if (warnTimer){ clearInterval(warnTimer); warnTimer = null; }
    }

    function showOverlay(){ overlay.style.display = "flex"; }
    function hideOverlay(){ overlay.style.display = "none"; }

    // ===== SHOP modal control =====
    function openShop(){
      shopModal.classList.add("open");
      // ëª¨ë‹¬ ì—´ë¦´ ë•Œ ìŠ¤í¬ë¡¤ ë§¨ ìœ„ë¡œ
      const shopBox = shopModal.querySelector(".shop");
      if (shopBox) shopBox.scrollTop = 0;
    }
    function closeShop(){
      shopModal.classList.remove("open");
    }

    // ëª¨ë‹¬ ë°°ê²½ í´ë¦­í•˜ë©´ ë‹«ê¸° (íŒ¨ë„ í´ë¦­ì€ ë¬´ì‹œ)
    shopModal.addEventListener("click", (e)=>{
      if (e.target === shopModal) closeShop();
    });

    // ESCë¡œ ë‹«ê¸°
    window.addEventListener("keydown", (e)=>{
      if (e.key === "Escape") closeShop();
    });

    // ===== HUD / SHOP sync =====
    function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }

    function syncHud(){
      levelEl.textContent = String(level);
      bankEl.textContent = String(bank);

      shopBankEl.textContent = String(bank);
      shopLevelEl.textContent = String(level);

      shopMulEl.textContent = "x" + fmt2(scoreBonusMultiplier());
      shopMoveEl.textContent = "x" + fmt2(moveSpeedMultiplier());
      shopHitEl.textContent = Math.round(playerHitScale() / BASE_PLAYER_HIT * 100) + "%";
      shopStarRateEl.textContent = "x" + fmt2(starRateMultiplier());
      shopHazSlowEl.textContent = Math.round(hazardSpeedMultiplier()*100) + "%";

      lvNowEl.textContent = String(level);
      mulNowEl.textContent = String(upgMul);
      moveNowEl.textContent = String(upgMove);
      hitNowEl.textContent = String(upgHit);
      starNowEl.textContent = String(upgStar);
      slowNowEl.textContent = String(upgSlow);
    }

    // ===== Run flow =====
    function resetRun(){
      stop();
      measureGame();
      clearObjects();

      scorePoints = 0;
      scoreEl.textContent = "0";
      timeEl.textContent = "0.0";

      px = Math.round(gW/2 - pSize/2);
      positionPlayer();
      showTouchHint(true);

      level = upgLevel;
      lastTier = -1;
      applyJetTier(true);

      closeShop();
      showOverlay();
    }

    function startGame(){
      closeShop();
      hideOverlay();
      showTouchHint(false);

      running = true;
      startAt = performance.now();
      lastTime = startAt;

      const m = modes[modeIdx];

      const starInterval = Math.max(380, Math.round(m.starRate / starRateMultiplier()));
      const hazardInterval = m.hazardRate;

      hazardTimer = setInterval(()=> {
        spawnHazardAt(Math.random() * (gW - 60));
      }, hazardInterval);

      starTimer = setInterval(spawnStar, starInterval);
      warnTimer = setInterval(spawnTelegraph, 220);

      raf = requestAnimationFrame(tick);
    }

    function gameOver(){
      if (!running) return;
      stop();
      sfxOver();

      const lived = (performance.now() - startAt) / 1000;
      const final = Math.floor(scorePoints * 10 + lived * 5);

      if (final > best) {
        best = final;
        localStorage.setItem(LS_BEST, String(best));
        bestEl.textContent = best;
      }

      game.classList.remove("shake");
      void game.offsetWidth;
      game.classList.add("shake");

      closeShop();
      showOverlay();
      showTouchHint(true);
    }

    // ===== Jet particles =====
    let particleAcc = 0;
    function spawnJetParticle(){
      const jp = document.createElement("div");
      jp.className = "jetParticle";

      const x = px + pSize/2 - 3;
      const y = py + pSize - 6;

      const dx = (Math.random()*16 - 8).toFixed(1) + "px";
      const dy = (18 + Math.random()*18).toFixed(1) + "px";

      jp.style.setProperty("--x", Math.round(x) + "px");
      jp.style.setProperty("--y", Math.round(y) + "px");
      jp.style.setProperty("--dx", dx);
      jp.style.setProperty("--dy", dy);

      const t = currentTier();
      const size = 5 + t * 1.3 + Math.random()*2.0;
      jp.style.width = size.toFixed(1) + "px";
      jp.style.height = size.toFixed(1) + "px";

      game.appendChild(jp);
      setTimeout(()=> jp.remove(), 620);
    }

    // ===== Main loop =====
    function tick(now){
      if (!running) return;
      const dt = Math.min(0.033, (now - lastTime) / 1000);
      lastTime = now;

      const lived = (now - startAt) / 1000;
      timeEl.textContent = lived.toFixed(1);

      const progress = Math.min(Math.max((lived - 10) / 110, 0), 1);
      const speedMultiplier = 1 + progress;

      const m = modes[modeIdx];

      const conf = JET_TIERS[currentTier()];
      particleAcc += dt * 1000;
      while (particleAcc >= conf.particleRate){
        particleAcc -= conf.particleRate;
        spawnJetParticle();
      }

      for (let i = warnings.length - 1; i >= 0; i--){
        const w = warnings[i];
        w.t += dt * 1000;

        if (w.t >= w.duration){
          for (let k=0;k<w.burst;k++){
            const offset = (w.burst === 2) ? (k===0 ? -18 : 18) : 0;
            const teleType = (Math.random() < 0.45) ? HAZARD_TYPES[3] : (Math.random() < 0.5 ? HAZARD_TYPES[2] : null);
            spawnHazardAt(w.x + offset, teleType, true);
          }
          w.line.remove();
          w.circle.remove();
          warnings.splice(i,1);
        }
      }

      const slowMul = hazardSpeedMultiplier();
      for (let i = hazards.length - 1; i >= 0; i--){
        const h = hazards[i];
        const base = m.hazardSpeed * h.speedMul * speedMultiplier * slowMul * h.tele;
        h.y += base * dt;

        if (m.zigzag || h.key === "comet" || h.key === "plasma" || h.key === "mini"){
          h.x += h.vx * dt * (0.85 + progress*0.75) * (1 + currentTier()*0.04);
        }
        if (h.key === "twister"){
          h.phase += dt * (3.0 + progress*2.0);
          h.x += Math.sin(h.phase) * (55 + progress*40) * dt;
        }
        if (h.key === "seeker"){
          const targetX = px + pSize/2 - h.w/2;
          h.vx += (targetX - h.x) * dt * (1.3 + progress*0.7);
          h.vx = clamp(h.vx, -280, 280);
          h.x += h.vx * dt;
        }

        const minX = 0;
        const maxX = gW - h.w;
        if (h.x <= minX){ h.x = minX; h.vx = Math.abs(h.vx); }
        if (h.x >= maxX){ h.x = maxX; h.vx = -Math.abs(h.vx); }

        if (h.key === "splitter" && !h.didSplit && h.splitAt != null && h.y >= h.splitAt){
          h.didSplit = true;
          spawnTierRing();
          spawnMini(h.x - 10, h.y + 10, -1);
          spawnMini(h.x + 10, h.y + 10,  1);
        }

        if (h.y > gH + 220){
          h.el.remove();
          hazards.splice(i, 1);
          continue;
        }

        h.el.style.setProperty("--x", h.x + "px");
        h.el.style.setProperty("--y", h.y + "px");

        if (aabbScaled(px, py, pSize, pSize, playerHitScale(), h.x, h.y, h.w, h.h, h.hitScale)){
          spawnExplosion(h.x + h.w/2, h.y + h.h/2);
          gameOver();
          return;
        }
      }

      for (let i = stars.length - 1; i >= 0; i--){
        const s = stars[i];
        s.y += m.starSpeed * (speedMultiplier * 1.45) * dt;

        if (s.y > gH + 180){
          s.el.remove();
          stars.splice(i, 1);
          continue;
        }

        s.el.style.setProperty("--x", s.x + "px");
        s.el.style.setProperty("--y", s.y + "px");

        if (aabbScaled(px, py, pSize, pSize, playerHitScale(), s.x, s.y, s.w, s.h, STAR_HIT_SCALE)){
          sfxCoin();
          s.el.remove();
          stars.splice(i, 1);

          const gain = gainMultiplier();
          scorePoints += gain;

          scoreEl.textContent = (scorePoints >= 1000)
            ? scorePoints.toFixed(0)
            : scorePoints.toFixed(1);

          popText(px + 4, py - 10, "+" + (gain >= 10 ? gain.toFixed(1) : gain.toFixed(2)));
        }
      }

      raf = requestAnimationFrame(tick);
    }

    // ===== Input =====
    const keyState = { left:false, right:false };
    function moveBy(dx){ setPlayerX(px + dx); }

    window.addEventListener("keydown", (e) => {
      const k = e.key.toLowerCase();
      if (e.key === "ArrowLeft" || k === "a") keyState.left = true;
      if (e.key === "ArrowRight" || k === "d") keyState.right = true;
    });
    window.addEventListener("keyup", (e) => {
      const k = e.key.toLowerCase();
      if (e.key === "ArrowLeft" || k === "a") keyState.left = false;
      if (e.key === "ArrowRight" || k === "d") keyState.right = false;
    });

    function controlLoop(){
      const base = isMobile ? 7 : 6;
      const speed = base * moveSpeedMultiplier();
      if (keyState.left) moveBy(-speed);
      if (keyState.right) moveBy(speed);
      requestAnimationFrame(controlLoop);
    }
    requestAnimationFrame(controlLoop);

    let dragging = false;
    function pointerX(e){
      const rect = game.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      let x = clientX - rect.left;
      if (e.touches) x -= 28;
      return x - pSize/2;
    }
    game.addEventListener("mousedown", (e)=>{ dragging = true; setPlayerX(pointerX(e)); });
    window.addEventListener("mousemove", (e)=>{ if(dragging) setPlayerX(pointerX(e)); });
    window.addEventListener("mouseup", ()=> dragging = false);

    game.addEventListener("touchstart", (e)=>{ dragging = true; setPlayerX(pointerX(e)); }, {passive:false});
    game.addEventListener("touchmove", (e)=>{ if(dragging) setPlayerX(pointerX(e)); }, {passive:false});
    game.addEventListener("touchend", ()=> dragging = false);

    // ===== Shop buy helpers =====
    const COST = 100;

    function canSpend(n){ return bank >= n; }
    function spend(n){ bank -= n; saveBank(bank); }

    function buyStat(which){
      if (!canSpend(COST)){
        popText(px + pSize/2 - 30, py - 20, "NO STAR!");
        return;
      }

      if (which === "lv"){
        if (upgLevel >= 100) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgLevel += 1;
        saveInt(LS_LV, upgLevel);
        level = upgLevel;
        lastTier = -1;
        applyJetTier(true);
        spawnTierRing();
        sfxBuy();
      }

      if (which === "mul"){
        if (upgMul >= 50) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgMul += 1;
        saveInt(LS_MUL, upgMul);
        sfxBuy();
      }

      if (which === "move"){
        if (upgMove >= 50) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgMove += 1;
        saveInt(LS_MOVE, upgMove);
        sfxBuy();
      }

      if (which === "hit"){
        if (upgHit >= 60) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgHit += 1;
        saveInt(LS_HIT, upgHit);
        sfxBuy();
      }

      if (which === "star"){
        if (upgStar >= 50) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgStar += 1;
        saveInt(LS_STAR, upgStar);
        sfxBuy();
      }

      if (which === "slow"){
        if (upgSlow >= 50) { popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
        spend(COST);
        upgSlow += 1;
        saveInt(LS_SLOW, upgSlow);
        sfxBuy();
      }

      syncHud();
    }

    buyLvBtn.addEventListener("click", ()=> buyStat("lv"));
    buyMulBtn.addEventListener("click", ()=> buyStat("mul"));
    buyMoveBtn.addEventListener("click", ()=> buyStat("move"));
    buyHitBtn.addEventListener("click", ()=> buyStat("hit"));
    buyStarRateBtn.addEventListener("click", ()=> buyStat("star"));
    buyHazSlowBtn.addEventListener("click", ()=> buyStat("slow"));

    buy10packBtn.addEventListener("click", ()=>{
      const need = COST * 10;
      if (!canSpend(need)){
        popText(px + pSize/2 - 32, py - 20, "NEED 1000");
        return;
      }
      const plan = [
        ["lv", 2, ()=> upgLevel < 100],
        ["mul",2, ()=> upgMul < 50],
        ["move",2,()=> upgMove < 50],
        ["hit",2, ()=> upgHit < 60],
        ["star",1,()=> upgStar < 50],
        ["slow",1,()=> upgSlow < 50],
      ];

      spend(need);

      for (const [k, cnt, ok] of plan){
        for (let i=0;i<cnt;i++){
          if (!ok()) continue;
          if (k==="lv"){ upgLevel++; }
          if (k==="mul"){ upgMul++; }
          if (k==="move"){ upgMove++; }
          if (k==="hit"){ upgHit++; }
          if (k==="star"){ upgStar++; }
          if (k==="slow"){ upgSlow++; }
        }
      }

      saveInt(LS_LV, upgLevel);
      saveInt(LS_MUL, upgMul);
      saveInt(LS_MOVE, upgMove);
      saveInt(LS_HIT, upgHit);
      saveInt(LS_STAR, upgStar);
      saveInt(LS_SLOW, upgSlow);

      level = upgLevel;
      lastTier = -1;
      applyJetTier(true);
      spawnTierRing();
      sfxBuy();
      syncHud();
    });

    buyMaxBtn.addEventListener("click", ()=>{
      if (upgLevel >= 100){ popText(px + pSize/2 - 18, py - 20, "MAX!"); return; }
      const needLv = 100 - upgLevel;
      const maxCan = Math.floor(bank / COST);
      const buyN = Math.min(needLv, maxCan);
      if (buyN <= 0){
        popText(px + pSize/2 - 30, py - 20, "NO STAR!");
        return;
      }
      spend(buyN * COST);
      upgLevel += buyN;
      saveInt(LS_LV, upgLevel);
      level = upgLevel;
      lastTier = -1;
      applyJetTier(true);
      spawnTierRing();
      sfxBuy();
      syncHud();
    });

    resetShopBtn.addEventListener("click", ()=>{
      bank = 10000;
      upgLevel = 0;
      upgMul = 0;
      upgMove = 0;
      upgHit = 0;
      upgStar = 0;
      upgSlow = 0;

      saveBank(bank);
      saveInt(LS_LV, upgLevel);
      saveInt(LS_MUL, upgMul);
      saveInt(LS_MOVE, upgMove);
      saveInt(LS_HIT, upgHit);
      saveInt(LS_STAR, upgStar);
      saveInt(LS_SLOW, upgSlow);

      level = upgLevel;
      lastTier = -1;
      applyJetTier(true);
      spawnTierRing();
      popText(px + pSize/2 - 42, py - 20, "RESET!");
      syncHud();
    });

    // ===== Buttons =====
    startBtn.addEventListener("click", () => {
      ensureAudioReady().then(() => { sfxStart(); startGame(); }).catch(() => startGame());
    });

    restartBtn.addEventListener("click", () => resetRun());

    hardBtn.addEventListener("click", () => {
      modeIdx = (modeIdx + 1) % modes.length;
      hardBtn.textContent = "ë‚œì´ë„: " + modes[modeIdx].name;
      resetRun();
    });

    openShopBtn.addEventListener("click", ()=> openShop());
    closeShopBtn.addEventListener("click", ()=> closeShop());

    window.addEventListener("resize", () => {
      measureGame();
      px = clamp(px, 0, gW - pSize);
      positionPlayer();
      showTouchHint(!running);
    });

    // ===== Init =====
    (function init(){
      startBg.style.backgroundImage = `url("${START_SCREEN_URL}")`;

      measureGame();
      px = Math.round(gW/2 - pSize/2);
      positionPlayer();

      bank = loadBank();
      upgLevel = clamp(loadInt(LS_LV, 0), 0, 100);
      upgMul   = clamp(loadInt(LS_MUL, 0), 0, 50);
      upgMove  = clamp(loadInt(LS_MOVE,0), 0, 50);
      upgHit   = clamp(loadInt(LS_HIT, 0), 0, 60);
      upgStar  = clamp(loadInt(LS_STAR,0), 0, 50);
      upgSlow  = clamp(loadInt(LS_SLOW,0), 0, 50);

      level = upgLevel;

      best = Number(localStorage.getItem(LS_BEST) || 0);
      bestEl.textContent = best;

      lastTier = -1;
      applyJetTier(true);

      syncHud();
      showTouchHint(true);
      showOverlay();

      // ëª¨ë°”ì¼ì€ ê¸°ë³¸ìœ¼ë¡œ SHOP ë‹«í˜(ë°°ê²½ ìµœëŒ€ ë…¸ì¶œ)
      closeShop();
    })();
  </script>
</body>
</html>
